{% extends "base.html" %}

{% block title %}Editar Patrimônio - Sistema de Patrimônio Escolar{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0">
                        <i class="fas fa-edit me-2"></i>
                        Editar Patrimônio
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
                        
                        
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Informações Básicas
                                </h5>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="nome" class="form-label">Nome do Patrimônio *</label>
                                <input type="text" class="form-control" id="nome" name="nome" 
                                       value="{{ patrimonio.nome }}" required>
                                <div class="invalid-feedback">
                                    Por favor, informe o nome do patrimônio.
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="origem" class="form-label">Origem/Quem Doou *</label>
                                <input type="text" class="form-control" id="origem" name="origem" 
                                       value="{{ patrimonio.origem }}" required
                                       oninput="formatarMaiusculasSemAcentos(this)">
                                <div class="invalid-feedback">
                                    Por favor, informe a origem/doação.
                                </div>
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label for="descricao" class="form-label">Descrição *</label>
                                <textarea class="form-control" id="descricao" name="descricao" rows="3" required>{{ patrimonio.descricao }}</textarea>
                                <div class="invalid-feedback">
                                    Por favor, informe uma descrição.
                                </div>
                            </div>
                        </div>

                   
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-map-marker-alt me-2"></i>
                                    Localização e Estado
                                </h5>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="localizacao" class="form-label">Localização *</label>
                                <input type="text" class="form-control" id="localizacao" name="localizacao" 
                                       value="{{ patrimonio.localizacao }}" required>
                                <div class="invalid-feedback">
                                    Por favor, informe a localização.
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="condicao" class="form-label">Condição *</label>
                                <select class="form-select" id="condicao" name="condicao" required>
                                    <option value="">Selecione a condição...</option>
                                    <option value="Ótimo" {% if patrimonio.condicao in ['Ótimo', 'otimo', 'ótimo'] %}selected{% endif %}>Ótimo</option>
                                    <option value="Bom" {% if patrimonio.condicao in ['Bom', 'bom'] %}selected{% endif %}>Bom</option>
                                    <option value="Recuperável" {% if patrimonio.condicao in ['Recuperável', 'recuperavel', 'recuperável'] %}selected{% endif %}>Recuperável</option>
                                    <option value="Péssimo" {% if patrimonio.condicao in ['Péssimo', 'pessimo', 'péssimo'] %}selected{% endif %}>Péssimo</option>
                                </select>
                                <div class="invalid-feedback">
                                    Por favor, selecione a condição.
                                </div>
                            </div>
                        </div>

                       
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-barcode me-2"></i>
                                    Informações Adicionais
                                </h5>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="marca" class="form-label">Marca</label>
                                <input type="text" class="form-control" id="marca" name="marca" 
                                       value="{{ patrimonio.marca or '' }}">
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="codigo_doador" class="form-label">Código do Doador</label>
                                <input type="text" class="form-control" id="codigo_doador" name="codigo_doador" 
                                       value="{{ patrimonio.codigo_doador or '' }}"
                                       placeholder="Apenas 7 números"
                                       pattern="[0-9]{7}"
                                       maxlength="7"
                                       oninput="validarApenasNumeros(this)">
                                <div class="invalid-feedback">
                                    O código deve conter exatamente 7 números.
                                </div>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="codigo_cps" class="form-label">Código CPS</label>
                                <input type="text" class="form-control" id="codigo_cps" name="codigo_cps" 
                                       value="{{ patrimonio.codigo_cps or '' }}"
                                       placeholder="Apenas 7 números"
                                       pattern="[0-9]{7}"
                                       maxlength="7"
                                       oninput="validarApenasNumeros(this)">
                                <div class="invalid-feedback">
                                    O código deve conter exatamente 7 números.
                                </div>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="quantidade" class="form-label">Quantidade *</label>
                                <input type="number" class="form-control" id="quantidade" name="quantidade" 
                                       value="{{ patrimonio.quantidade }}" min="1" required>
                                <div class="invalid-feedback">
                                    A quantidade deve ser maior que zero.
                                </div>
                            </div>
                        </div>

                        <!-- Imagem -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-image me-2"></i>
                                    Imagem do Patrimônio
                                </h5>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="imagem" class="form-label">Nova Foto (Opcional)</label>
                                <input type="file" class="form-control" id="imagem" name="imagem" 
                                       accept=".png,.jpg,.jpeg,.gif,.webp">
                                <small class="form-text text-muted">
                                    Deixe em branco para manter a imagem atual
                                </small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                {% if patrimonio.imagem %}
                                <label class="form-label">Imagem Atual</label>
                                <div>
                                    <img src="{{ url_for('servir_imagem', filename=patrimonio.imagem) }}" 
                                         alt="{{ patrimonio.nome }}" 
                                         class="img-thumbnail" 
                                         style="max-width: 200px; max-height: 200px;">
                                    <br>
                                    <small class="text-muted">Imagem atual do patrimônio</small>
                                </div>
                                {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Nenhuma imagem cadastrada
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Botões -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="{{ url_for('listar') }}" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left me-2"></i>Cancelar
                                    </a>
                                    <button type="submit" class="btn btn-warning">
                                        <i class="fas fa-save me-2"></i>Atualizar Patrimônio
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>

function formatarMaiusculasSemAcentos(input) {
   
    let texto = input.value.normalize('NFD').replace(/[\u0300-\u036f]/g, '');

    texto = texto.toUpperCase();
  
    input.value = texto;
}


function validarApenasNumeros(input) {
  
    input.value = input.value.replace(/[^0-9]/g, '');
    
  
    if (input.value.length > 7) {
        input.value = input.value.slice(0, 7);
    }
}


document.addEventListener('DOMContentLoaded', function() {
    const origemInput = document.getElementById('origem');
    if (origemInput) {
       
        formatarMaiusculasSemAcentos(origemInput);
        
       
        origemInput.addEventListener('input', function() {
            formatarMaiusculasSemAcentos(this);
        });
    }
    
    
    const codigoDoador = document.getElementById('codigo_doador');
    const codigoCps = document.getElementById('codigo_cps');
    
    if (codigoDoador) {
        codigoDoador.addEventListener('input', function() {
            validarApenasNumeros(this);
        });
       
        validarApenasNumeros(codigoDoador);
    }
    
    if (codigoCps) {
        codigoCps.addEventListener('input', function() {
            validarApenasNumeros(this);
        });
        
        validarApenasNumeros(codigoCps);
    }

    const form = document.querySelector('form');
    form.addEventListener('submit', function(event) {
        const origemInput = document.getElementById('origem');
        if (origemInput && !origemInput.value.trim()) {
            event.preventDefault();
            event.stopPropagation();
            origemInput.classList.add('is-invalid');
        }
        
       
        const codigoDoador = document.getElementById('codigo_doador');
        const codigoCps = document.getElementById('codigo_cps');
        
        if (codigoDoador && codigoDoador.value && codigoDoador.value.length !== 7) {
            event.preventDefault();
            event.stopPropagation();
            codigoDoador.classList.add('is-invalid');
        }
        
        if (codigoCps && codigoCps.value && codigoCps.value.length !== 7) {
            event.preventDefault();
            event.stopPropagation();
            codigoCps.classList.add('is-invalid');
        }
    });
});
</script>
{% endblock %}
